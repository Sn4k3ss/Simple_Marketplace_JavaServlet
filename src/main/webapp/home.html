<!DOCTYPE html>

<html lang="en">

<head>

    <title>Marketplace App</title>
    <meta charset="UTF-8">

    <link rel="stylesheet" type="text/css" media="all" href="./css/global.css"/>
    <link rel="stylesheet" type="text/css" media="all" href="./css/loading.css" />
    <link rel="stylesheet" type="text/css" media="all" href="./css/error.css" />

    <link rel="icon" type="image/ico" th:href="@{/images/website-icon.ico}" href="./images/website-icon.ico"/>
    <script src="./js/utils.js" charset="utf-8" defer></script>
    <script src="./js/marketplace.js" charset="utf-8" defer></script>

</head>

<body>

    <!-- HEADER -->
    <header>
        <div>
            <a id="homepage-link-logo" href="#" class="logo">
                <img id="homepage-logo-img" alt="website-logo.png" src="./images/website-logo.png"/>
            </a>
            <div class="header-right">
                <a id="home-link" href="#" class="active">Home</a>
                <a id="shopping-cart-link" href="#">Shopping cart</a>
                <a id="orders-link" href="#">My Orders</a>
                <a id="logout-link" href="#">Logout</a>
            </div>
        </div>
    </header>

    <div class="title">
        <h1>Welcome to our marketplace <span id="title-username" >Amadeus</span> </h1>
    </div>


    <!-- SEARCH FORM -->
    <div id="search-form-div" class="search-form">
        <form th:action="${#request.contextPath} + '/search/products'" method="GET">
            <div class="form-group">
                <input th:placeholder="'Oasis latest album...'" name="keyword" >
                <input id="search-form-div-button" class="button" type="submit" value="Go!">
            </div>
        </form>
        <div id="search-form-error" >Error!</div>
    </div>


    <!-- HOME PRODUCTS TABLE -->
    <div id="products-table-div">
        <table class="styled-table">
            <caption></caption>
            <thead>
            <tr>
                <th colspan="2" scope="col">Product</th>
                <th scope="col">Description</th>
                <th scope="col">Cost</th>
                <th scope="col">Supplier</th>
                <th scope="col">Add to cart</th>
            </tr>
            </thead>

            <tbody id="products-table-body">
            <!--
            <tr>


                <td class="table-product-img">
                    <img th:src="'https://tiw21marketplace.s3.eu-south-1.amazonaws.com/images/products/'+ ${productInfo1.productImagePath}" alt="Product image" src="./images/prod-ex.jpeg"/>
                </td>



                <td> <a class="clickable-link" th:href="@{/GoToHome( productId=${productId} , productName=${productInfo1.productName} )}" th:text="${productInfo1.productName}"> Nome prodotto</a> </td>



                <td th:text="${productInfo1.productDescription}"></td>



                <td>&euro; <span th:text="${#numbers.formatDecimal(productInfo1.supplierProductCost, 1, 2, 'COMMA')}">10.00</span> </td>



                <td class="table-supplier-img">
                    <img th:src="'https://tiw21marketplace.s3.eu-south-1.amazonaws.com/images/suppliers/'+ ${productInfo1.supplier.imagePath}" alt="Product image" src="./images/suppl-ex.png"/>
                </td>



                <td>
                    <form th:class="styled-form"
                          th:action="${#request.contextPath} + '/products/AddToCart'"
                          th:object="${productInfo1}"
                          method="POST" >

                        <input type="hidden" th:value="${productInfo1.productId}"    name="productId" />
                        <input type="hidden" th:value="${productInfo1.supplierId}"   name="supplierId" />
                        <input type="hidden" th:value="${productInfo1.supplierProductCost}"   name="supplierProductCost" />
                        <input class="clickable-link clickable-link-medium" type="submit" value="One-click buy" />
                    </form>
                </td>
            </tr>

            -->
            </tbody>
        </table>
    </div>


    <!-- SEARCH PRODUCTS TABLE -->
    <div id="search-products-table-div" >
        <table class="styled-table">
            <caption>Products from the marketplace</caption>
            <thead>
            <tr>
                <th colspan="2" scope="col">Product</th>
                <th scope="col">Description</th>
                <th scope="col">Cost</th>
                <th colspan="2" scope="col">Supplier</th>
                <th scope="col">Add to cart</th>
                <th colspan="4" scope="col"></th>
            </tr>
            </thead>

            <tbody th:each="productId : ${products.supplierProductMap.keySet()}">
            <tr  th:with="productInfo1=${products.supplierProductMap.get(productId)[0]}">

                <!-- IMMAGINE PRODOTTO -->
                <td class="table-product-img">
                    <a th:href="@{/search/products/ShowProductInfo(productId=${productId})}" >
                        <img th:src="'https://tiw21marketplace.s3.eu-south-1.amazonaws.com/images/products/'+ ${productInfo1.productImagePath}" alt="Product-image" src=""/>
                    </a>
                </td>

                <!-- NOME PRODOTTO -->
                <td> <a class="clickable-link" th:href="@{/search/products/ShowProductInfo( productId=${productId} , productName=${productInfo1.productName} )}" th:text="${productInfo1.productName}"> Nome prodotto</a> </td>

                <!-- DESCRIZIONE PRODOTTO -->
                <td th:text="${productInfo1.productDescription}">No desc</td>

                <!-- PREZZO PRODOTTO -->
                <td>&euro; <span th:text="${#numbers.formatDecimal(productInfo1.supplierProductCost, 1, 2, 'COMMA')}">10.00</span> </td>

                <!-- IMMAGINE SUPPLIER -->
                <td class="table-supplier-img">
                    <img th:src="'https://tiw21marketplace.s3.eu-south-1.amazonaws.com/images/suppliers/'+ ${productInfo1.supplier.imagePath}" alt="supplier-image"/>
                </td>

                <!-- NOME SUPPLIER -->
                <td th:text="${productInfo1.supplierName}">Supplier name</td>

                <!-- BUY BUTTON -->
                <td>
                    <form th:action="${#request.contextPath} + '/products/AddToCart'"  th:object="${productInfo1}" method="POST">
                        <input type="hidden" th:value="*{productId}"    name="productId" />
                        <input type="hidden" th:value="*{supplierId}"   name="supplierId" />
                        <input type="hidden" th:value="*{supplierProductCost}"   name="supplierProductCost" />
                        <input type="submit" class="clickable-link clickable-link-medium" value="One-click buy" />
                    </form>
                </td>

            </tr>

            <tr th:with="productInfo1=${products.supplierProductMap.get(productId)[0]}">
                <!-- TABLE CON INFO SUI VENDITORI-->
                <td colspan="7">
                    <table class="styled-table" th:if="${selectedProductId.equals(productInfo1.productId)}" >
                        <thead>

                        <tr>
                            <th scope="col">Supplier</th>
                            <th scope="col">Cost</th>
                            <th scope="col">Rating</th>
                            <th scope="col">Free shipping from</th>
                            <th scope="col">Range</th>
                            <th scope="col">Items already in cart</th>
                            <th scope="col">Amount</th>
                            <th scope="col">Add to cart</th>
                        </tr>

                        </thead>
                        <tr th:each="supplierProduct : ${products.supplierProductMap.get(selectedProductId)}">

                            <!-- IMMAGINE SUPPLIER -->
                            <td class="table-supplier-img">
                                <img th:src="'https://tiw21marketplace.s3.eu-south-1.amazonaws.com/images/suppliers/'+ ${supplierProduct.supplier.imagePath}" alt="supplier-image" src="./images/suppl-ex.png"/>
                            </td>

                            <!-- PREZZO PRODOTTO -->
                            <td>&euro; <span th:text="${#numbers.formatDecimal(supplierProduct.supplierProductCost, 1, 2, 'COMMA')}">10.00</span> </td>

                            <!-- RATING SUPPLIER -->
                            <td th:text="${supplierProduct.supplier.supplierRating}">0.0</td>

                            <!-- SUPPLIER FREE SHIPPING YES -->
                            <td th:if="${supplierProduct.supplier.hasFreeShipping}" >&euro; <span th:text="${#numbers.formatDecimal(supplierProduct.supplier.freeShippingMinAmount, 1, 2, 'COMMA')}">10.00</span> </td>

                            <!-- SUPPLIER FREE SHIPPING NO -->
                            <td th:if="${!supplierProduct.supplier.hasFreeShipping}" th:text="'No'"></td>

                            <!-- SUPPLIER RANGE COSTS -->
                            <td>
                                <table class="styled-table">
                                    <thead>
                                    <tr>
                                        <th scope="col">Range</th>
                                        <th scope="col">minItem</th>
                                        <th scope="col">maxItem</th>
                                        <th scope="col">cost</th>
                                    </tr>
                                    </thead>
                                    <tr th:each="range : ${supplierProduct.supplier.supplierShippingPolicy.ranges}" >
                                        <td th:text="${supplierProduct.supplier.supplierShippingPolicy.ranges.indexOf(range) + 1}">1</td>
                                        <td th:text="${range.minAmount}">1</td>
                                        <td th:text="${range.maxAmount}">5</td>
                                        <td>&euro; <span th:text="${#numbers.formatDecimal(range.cost, 1, 2, 'COMMA')}">10.00</span> </td>
                                    </tr>
                                </table>
                            </td>

                            <!-- HOW MANY ITEMS -->
                            <td th:if="${session.shoppingCart.totalItemsBySupplier.get(supplierProduct.supplierId)}" th:text="${session.shoppingCart.totalItemsBySupplier.get(supplierProduct.supplierId)}" >3</td>
                            <td th:unless="${session.shoppingCart.totalItemsBySupplier.get(supplierProduct.supplierId)}" >0</td>


                            <!-- HOW MUCH TOTAL -->
                            <td th:if="${session.shoppingCart.totalAmountBySupplier.get(supplierProduct.supplierId)}">&euro; <span th:text="${#numbers.formatDecimal(session.shoppingCart.totalAmountBySupplier.get(supplierProduct.supplierId), 1, 2, 'COMMA')}">10.00</span> </td>
                            <td th:unless="${session.shoppingCart.totalAmountBySupplier.get(supplierProduct.supplierId)}">&euro; <span th:text="${#numbers.formatDecimal(0, 1, 2, 'COMMA')}">10.00</span> </td>


                            <!-- ADD TO CART FORM -->
                            <td>
                                <form th:action="${#request.contextPath} + '/products/AddToCart'" method="POST">
                                    <label for="howMany">How many:</label>
                                    <select name="howMany" id="howMany">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                    </select>
                                    <input type="hidden" th:value="${supplierProduct.productId}"    name="productId" />
                                    <input type="hidden" th:value="${supplierProduct.supplierId}"   name="supplierId" />
                                    <input type="hidden" th:value="${supplierProduct.supplierProductCost}"   name="supplierProductCost" />
                                    <input type="submit" class="clickable-link clickable-link-medium" value="Add to cart">
                                </form>
                            </td>

                        </tr>
                    </table>
                </td>
            </tr>

            </tbody>
        </table>
    </div>


    <!-- SHOPPINC CART -->
    <div id="shopping-cart-div">
        <div id="shopping-cart-div-message"> Prodotto aggiunto nel carrello con successo</div>
            <table  class="styled-table" style="width:100%">
                <caption style="lighting-color: #04aa6d">CART</caption>
                <thead>
                <tr>
                    <th colspan="2" scope="col">Product name</th>
                    <th scope="col">Product Description</th>
                    <th scope="col">Category</th>
                    <th scope="col">Cost</th>
                    <th scope="col">How many</th>
                </tr>
                </thead>
                <tbody th:each="supplierId : ${session.shoppingCart.shoppingCartMap.keySet()}" th:with="supplierInfo=${session.shoppingCart.shoppingCartMap.get(supplierId)[0].supplier}" >

                <tr th:each="product : ${session.shoppingCart.shoppingCartMap.get(supplierId)}" >
                    <td class="table-product-img">
                        <img th:src="'https://tiw21marketplace.s3.eu-south-1.amazonaws.com/images/products/'+ ${product.productImagePath}" alt="Product image" src="./images/prod-ex.jpeg"/>
                    </td>
                    <td th:text="${product.productName}">Prod1</td>
                    <td th:text="${product.productDescription}">Desc1</td>
                    <td th:text="${product.productCategory}">Cat1</td>
                    <td>&euro; <span th:text="${#numbers.formatDecimal(product.supplierProductCost, 1, 2, 'COMMA')}">10.00</span> </td>
                    <td th:text="${product.howMany}">5</td>
                </tr>
                <tr class="active-row" th:with="totalamount=${session.shoppingCart.totalAmountBySupplier.get(supplierId)}">

                    <td>Total amount on <span th:text="${supplierInfo.supplierName}">Suppl1</span> &euro; <span th:text="${#numbers.formatDecimal(totalamount, 1, 2, 'COMMA')}">10.00</span></td>

                    <td th:if="${ !supplierInfo.hasFreeShipping }"> <span th:text=" ${supplierInfo.supplierName}">Suppl1</span> doesn't offer free shipping </td>

                    <td th:if="${ totalamount < supplierInfo.freeShippingMinAmount && supplierInfo.hasFreeShipping}">Free shipping on<span th:text="${supplierInfo.supplierName}">Suppl1</span>: &euro;<span th:text="${#numbers.formatDecimal(supplierInfo.freeShippingMinAmount, 1, 2, 'COMMA')}">10.00</span></td>

                    <td th:if="${ totalamount >= supplierInfo.freeShippingMinAmount && supplierInfo.hasFreeShipping}" th:text="'You\'re getting free shipping'"> Spesa minima per spedizione gratuita </td>
                    <td>
                        <form  th:action="${#request.contextPath} + '/PlaceOrder'" method="POST">
                            <label th:for="addreesId">Select an address
                                <select th:name="userShippingAddressId">
                                    <option th:each="address : ${shoppingAddresses}" th:value="${address.shippingAddressId}"
                                            th:text="${address.recipient} + ' ' + ${address.address} +  ' ' + ${address.city} +  ' ' + ${address.state} +  ' ' + ${address.phone}"
                                            th:selected="${address.shippingAddressId == 1}">
                                    </option>
                                </select>
                            </label>
                            <input type="hidden"  name="supplierId" th:value="${supplierId}" >
                            <input type="submit" class="clickable-link clickable-link-large" value="Place order">
                        </form>
                    </td>
                </tr>


                </tbody>
            </table>
    </div>


    <!-- ORDERS -->
    <div id="orders-div" >
        <table th:each="order : ${orders}" class="styled-table">
            <caption></caption>
            <thead>
            <tr>
                <th scope="col">Order id</th>
                <th scope="col">Order placement date</th>
                <th scope="col">Supplier</th>
                <th scope="col">Order amount</th>
                <th scope="col">Shipping fees</th>
                <th scope="col">Delivery date</th>
                <th scope="col">Address</th>
            </tr>
            </thead>

            <tbody>
            <tr>
                <td th:text="${order.orderId}">#0</td>
                <td th:text="${#temporals.format(order.orderPlacementDate, 'dd-MMM-yyyy')}">1-1-1970 00:00</td>

                <td class="table-supplier-img">
                    <img th:src="'https://tiw21marketplace.s3.eu-south-1.amazonaws.com/images/suppliers/'+ ${order.orderSupplier.imagePath}" alt="Product image" src="./images/suppl-ex.png"/>
                </td>

                <td>&euro; <span th:text="${#numbers.formatDecimal(order.orderAmount, 1, 2, 'COMMA')}">999,9</span> </td>
                <td>&euro; <span th:text="${#numbers.formatDecimal(order.orderShippingFees, 1, 2, 'COMMA')}">10,9</span> </td>
                <td th:text="${#temporals.format(order.deliveryDate, 'dd-MMM-yyyy')}">1-1-1970 00:00</td>
                <td> <span th:text="${order.shippingAddress.recipient}"></span> <span th:text="${order.shippingAddress.address}"></span> <span th:text="${order.shippingAddress.city}"></span> <span th:text="${order.shippingAddress.state}"></span> <span th:text="${order.shippingAddress.phone}"> </span> </td>

                <table class="styled-product-in-order-table">
                    <caption></caption>
                    <tbody>
                    <tr th:each="product : ${order.orderProductsList}">
                        <td class="table-product-img">
                            <img th:src="'https://tiw21marketplace.s3.eu-south-1.amazonaws.com/images/products/'+ ${product.productImagePath}" alt="Product image" src="./images/prod-ex.jpeg"/>
                        </td>
                        <td th:text="${product.productName}">Nike Air Max 270 X Mozart limited edition</td>
                        <td th:text="${product.productDescription}">Scarpe bellissime</td>
                        <td th:text="${product.productCategory}">Scarpe e abbigliamento</td>
                        <td th:text="${product.howMany}">3</td>
                        <td>&euro; <span th:text="${#numbers.formatDecimal(product.supplierProductCost, 1, 2, 'COMMA')}">99,9</span> </td>
                    </tr>
                    </tbody>
                </table>
            </tr>
            </tbody>
        </table>
    </div>


    <!-- ERROR LOADING PRODUCTS -->
    <div class="error-div">
        <img class="error-image" src="./images/error.jpg" alt="error-image"/>

        <div class="error-title">An error occured</div>
        <div class="error-reason">
            Your error is: <strong><span th:text="${errorMessage}">sample error</span></strong>
        </div>
        <div th:if="${session.user == null}">
            <hr>
            <a th:href="@{/}">Press here to go back to the login page</a>
        </div>
    </div>


<div class="loading-div">
    <img class="loading-img" src="./images/loading.gif" alt="loading-gif"/>
    <div id="loading_msg" class="loading-message">Communicating with Server ...</div>
</div>

</body>
</html>